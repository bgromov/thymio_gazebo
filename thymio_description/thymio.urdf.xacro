<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="thymio">
  <xacro:arg name="robot_ns" default="thymio"/>
  <xacro:property name="robot_ns" value="$(arg robot_ns)"/>
  <xacro:macro name="proximity_sensor" params="name parent_link:=base_link xyz rpy update_rate:=10 range_min:=0.005 range_max:=0.06 resolution:=0.005 fov:=0.4">
    <link name="${name}_link">
      <inertial>
        <mass value="1e-3"/>
        <inertia ixx="1e-3" ixy="0" ixz="0" iyy="1e-3" iyz="0" izz="1e-3"/>
      </inertial>
    </link>
    <joint name="${name}_joint" type="fixed">
      <origin xyz="${xyz}" rpy="${rpy}"/>
      <parent link="${parent_link}"/>
      <child link="${name}_link"/>
    </joint>
    <gazebo reference="${name}_link">
      <sensor name="${name}_sensor" type="ray">
        <visualize>true</visualize>
        <update_rate>${update_rate}</update_rate>
        <always_on>true</always_on>
        <ray>
          <range>
            <min>${range_min}</min>
            <max>${range_max}</max>
            <resolution>${resolution}</resolution>
          </range>
        </ray>
        <plugin name="${name}_controller" filename="libgazebo_ros_range.so">
          <alwaysOn>true</alwaysOn>
          <updateRate>${update_rate}</updateRate>
          <robotNamespace>${robot_ns}</robotNamespace>
          <frameName>${robot_ns}/${name}_link</frameName>
          <topicName>${name}</topicName>
          <radiation>infrared</radiation>
          <fov>${fov}</fov>
          <gaussianNoise>${resolution/2}</gaussianNoise>
        </plugin>
      </sensor>
    </gazebo>
  </xacro:macro>
  <xacro:macro name="thymio_robot">
    <link name="base_link">
      <inertial>
        <mass value="0.200"/>
        <inertia ixx="0.00024282" ixy="0" ixz="0" iyy="0.00023542" iyz="0" izz="0.00041073"/>
      </inertial>
      <collision>
        <geometry>
          <mesh filename="package://thymio_description/meshes/thymio_body_collision.dae"/>
        </geometry>
      </collision>
      <collision>
        <origin xyz="0.035 0 0"/>
        <geometry>
          <sphere radius="0.009"/>
        </geometry>
      </collision>
      <visual>
        <geometry>
          <mesh filename="package://thymio_description/meshes/thymio_body.dae"/>
        </geometry>
      </visual>
      <visual>
        <geometry>
          <mesh filename="package://thymio_description/meshes/thymio_proximity_sensors.dae"/>
        </geometry>
      </visual>
    </link>
    <joint name="left_wheel_joint" type="continuous">
      <parent link="base_link"/>
      <child link="left_wheel_link"/>
      <axis xyz="0 1 0"/>
      <origin xyz="-0.025 0.047 0.013"/>
    </joint>
    <gazebo reference="base_link">
      <selfCollide>true</selfCollide>
      <mu1>0.0</mu1>
      <mu2>0.0</mu2>
    </gazebo>
    <link name="left_wheel_link">
      <inertial>
        <mass value="0.025"/>
        <inertia ixx="0.00000363" ixy="0" ixz="0" iyy="0.00000605" iyz="0" izz="0.00000363"/>
      </inertial>
      <collision>
        <origin xyz="0 0.00175 0" rpy="1.5707 0 0"/>
        <geometry>
          <cylinder radius="0.022" length="0.015"/>
        </geometry>
      </collision>
      <visual>
        <geometry>
          <mesh filename="package://thymio_description/meshes/thymio_left_wheel.dae"/>
        </geometry>
      </visual>
    </link>
    <joint name="right_wheel_joint" type="continuous">
      <parent link="base_link"/>
      <child link="right_wheel_link"/>
      <axis xyz="0 1 0"/>
      <origin xyz="-0.025 -0.047 0.013"/>
    </joint>
    <link name="right_wheel_link">
      <inertial>
        <mass value="0.025"/>
        <inertia ixx="0.00000363" ixy="0" ixz="0" iyy="0.00000605" iyz="0" izz="0.00000363"/>
      </inertial>
      <collision>
        <origin xyz="0 -0.00175 0" rpy="1.5707 0 0"/>
        <geometry>
          <cylinder radius="0.022" length="0.015"/>
        </geometry>
      </collision>
      <visual>
        <geometry>
          <mesh filename="package://thymio_description/meshes/thymio_right_wheel.dae"/>
        </geometry>
      </visual>
    </link>
    <!--xacro:proximity_sensor name="proximity_center" xyz="0.055 0 0.026" rpy="0 0 0"/>
    <xacro:proximity_sensor name="proximity_center_left" xyz="0.0509 0.0252 0.026" rpy="0 0 0.32"/>
    <xacro:proximity_sensor name="proximity_center_right" xyz="0.0509 -0.0252 0.026" rpy="0 0 -0.32"/>
    <xacro:proximity_sensor name="proximity_left" xyz="0.0392 0.0478 0.026" rpy="0 0 0.64"/>
    <xacro:proximity_sensor name="proximity_right" xyz="0.0392 -0.0478 0.026" rpy="0 0 -0.64"/>
    <xacro:proximity_sensor name="proximity_rear_left" xyz="-0.055 0.03 0.026" rpy="0 0 3.14159"/>
    <xacro:proximity_sensor name="proximity_rear_right" xyz="-0.055 -0.03 0.026" rpy="0 0 3.14159"/>
    <xacro:proximity_sensor name="ground_left" xyz="0.04657 0.01155 0.0" rpy="0 1.5708 0"/>
    <xacro:proximity_sensor name="ground_right" xyz="0.04657 -0.01155 0.0" rpy="0 1.5708 0"/-->

    <xacro:proximity_sensor name="proximity_center" xyz="0.055 0 0.026" rpy="0 0 0"/>
    <xacro:proximity_sensor name="proximity_center_left" xyz="0.0506 0.0261 0.026" rpy="0 0 0.33161"/>
    <xacro:proximity_sensor name="proximity_center_right" xyz="0.0506 -0.0261 0.026" rpy="0 0 -0.33161"/>
    <xacro:proximity_sensor name="proximity_left" xyz="0.0380 0.0493 0.026" rpy="0 0 0.66323"/>
    <xacro:proximity_sensor name="proximity_right" xyz="0.0380 -0.0493 0.026" rpy="0 0 -0.66323"/>
    <xacro:proximity_sensor name="proximity_rear_left" xyz="-0.055 0.0305 0.026" rpy="0 0 3.14159"/>
    <xacro:proximity_sensor name="proximity_rear_right" xyz="-0.055 -0.0305 0.026" rpy="0 0 3.14159"/>
    <xacro:proximity_sensor name="ground_left" xyz="0.04657 0.01155 0.0" rpy="0 1.5708 0.24311"/>
    <xacro:proximity_sensor name="ground_right" xyz="0.04657 -0.01155 0.0" rpy="0 1.5708 -0.24311"/>

    <gazebo>
      <plugin name="differential_drive_controller" filename="libgazebo_ros_diff_drive.so">
        <alwaysOn>true</alwaysOn>
        <updateRate>100</updateRate>
        <leftJoint>right_wheel_joint</leftJoint>
        <rightJoint>left_wheel_joint</rightJoint>
        <wheelSeparation>0.0955</wheelSeparation>
        <wheelDiameter>0.044</wheelDiameter>
        <wheelTorque>0.005</wheelTorque>
        <commandTopic>cmd_vel</commandTopic>
        <odometryTopic>odom</odometryTopic>
        <odometryFrame>odom</odometryFrame>
        <publishWheelJointState>true</publishWheelJointState>
        <publishWheelTF>true</publishWheelTF>
        <publishTf>1</publishTf>
        <robotNamespace>${robot_ns}</robotNamespace>
        <robotBaseFrame>base_link</robotBaseFrame>
      </plugin>
    </gazebo>
  </xacro:macro>
  <xacro:thymio_robot />
</robot>
